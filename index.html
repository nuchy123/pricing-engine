<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mortgage Pricing Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Mortgage Pricing Hub</h1>
        <p class="text-sm text-slate-600">
          Simple, user-friendly pricing: only note rate & monthly P&I shown to the front end.
        </p>
        <p class="text-xs text-slate-500">
          All LLPA, payup incentives, and broker compensation are applied internally.
        </p>
      </div>
      <div class="flex gap-2 items-center">
        <span class="inline-flex items-center rounded-full bg-slate-900 text-xs text-slate-50 px-3 py-1">
          Conventional / HP / HR / HB
        </span>
        <a href="xls-upload.html"
           class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-800 text-xs px-3 py-1 hover:bg-emerald-200">
          Admin XLS Upload
        </a>
      </div>
    </header>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- Left: Scenario Details -->
      <section class="bg-white rounded-2xl shadow-lg p-5">
        <h2 class="text-lg font-semibold text-slate-900 mb-4">Scenario Details</h2>
        <p class="text-xs text-slate-500 mb-4">
          Fill in the basic loan scenario. LTV and location are calculated automatically to keep it simple for Realtors and borrowers.
        </p>

        <form id="pricingForm" class="space-y-3">
          <!-- Program -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Program</label>
            <select id="programSelect"
                    class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
              <!-- options will be filled from pricingModel -->
            </select>
            <p class="text-[0.68rem] text-slate-500 mt-1">
              Loaded dynamically from the uploaded rate sheet.
            </p>
          </div>

          <!-- Lock Term -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Lock Term</label>
            <select id="lockTermSelect"
                    class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
              <!-- filled based on program -->
            </select>
          </div>

          <!-- Occupancy -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Occupancy</label>
            <select id="occupancySelect"
                    class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="primary" selected>Primary Residence</option>
              <option value="second">Second Home</option>
              <option value="investment">Investment Property</option>
            </select>
          </div>

          <!-- Property Type -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Property Type</label>
            <select id="propertyTypeSelect"
                    class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="sfr_pud" selected>Single Family / PUD</option>
              <option value="condo_warrantable">Warrantable Condo</option>
              <option value="condo_non_warrantable">Non-Warrantable Condo</option>
              <option value="2_4_unit">2-4 Units</option>
              <option value="manufactured">Manufactured</option>
            </select>
          </div>

          <!-- FICO -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">FICO</label>
            <select id="ficoSelect"
                    class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="780plus" selected>780+</option>
              <option value="760_779">760 - 779</option>
              <option value="740_759">740 - 759</option>
              <option value="720_739">720 - 739</option>
              <option value="700_719">700 - 719</option>
              <option value="680_699">680 - 699</option>
              <option value="660_679">660 - 679</option>
              <option value="640_659">640 - 659</option>
              <option value="620_639">620 - 639</option>
              <option value="lt620">< 620</option>
            </select>
          </div>

          <!-- Loan Purpose -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Loan Purpose</label>
            <select id="loanPurposeSelect"
                    class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500">
              <option value="purchase" selected>Purchase</option>
              <option value="rate_term">Rate &amp; Term Refi</option>
              <option value="cash_out">Cash-Out Refi</option>
            </select>
          </div>

          <!-- ZIP + Location -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">ZIP Code</label>
            <input id="zipInput" type="text" inputmode="numeric"
                   class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500"
                   placeholder="e.g. 11230" />
            <p id="locationDisplay" class="text-[0.68rem] text-slate-500 mt-1">
              Location auto: – (County: –)
            </p>
          </div>

          <!-- Purchase Price / Loan Amount / LTV -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Purchase Price</label>
              <input id="purchasePriceInput" type="number" min="0" step="1000"
                     class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500"
                     placeholder="e.g. 700000" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Loan Amount</label>
              <input id="loanAmountInput" type="number" min="0" step="1000"
                     class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500"
                     placeholder="Enter or auto" />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">LTV (%)</label>
              <input id="ltvInput" type="number" min="0" max="200" step="0.01"
                     class="w-full rounded-lg border-slate-300 text-sm focus:ring-blue-500 focus:border-blue-500"
                     placeholder="Enter or auto" />
            </div>
          </div>

          <p class="text-[0.68rem] text-slate-500">
            Either enter <strong>Purchase Price + Loan Amount</strong> and LTV will auto-fill,
            or <strong>Purchase Price + LTV</strong> and Loan Amount will auto-fill.
          </p>

          <div class="pt-3">
            <button type="submit"
                    class="inline-flex items-center justify-center rounded-full bg-blue-600 text-white text-sm font-semibold px-5 py-2 hover:bg-blue-700">
              Get Pricing
            </button>
          </div>
        </form>
      </section>

      <!-- Right: Pricing Result -->
      <section class="bg-white rounded-2xl shadow-lg p-5">
        <h2 class="text-lg font-semibold text-slate-900 mb-4">Pricing Result</h2>
        <div id="pricingResult" class="text-sm text-slate-700">
          <p class="text-sm text-slate-500">
            No scenario calculated yet. Fill in the form and click
            <span class="font-semibold">Get Pricing</span>.
          </p>
        </div>
      </section>
    </div>
  </div>

  <script>
    const PRICING_MODEL_KEY = "pricingModel_v1";
    const BROKER_COMP_PERCENT = 2.5; // always added on top (lender-paid)

    let pricingModel = null;

    document.addEventListener("DOMContentLoaded", () => {
      loadPricingModelFromStorage();
      initForm();
    });

    function loadPricingModelFromStorage() {
      try {
        const text = localStorage.getItem(PRICING_MODEL_KEY);
        if (!text) return;
        pricingModel = JSON.parse(text);

        if (!pricingModel || !pricingModel.programs) {
          pricingModel = null;
          return;
        }

        populateProgramDropdown();
      } catch (e) {
        console.error("Error loading pricing model:", e);
        pricingModel = null;
      }
    }

    function populateProgramDropdown() {
      const programSelect = document.getElementById("programSelect");
      const lockTermSelect = document.getElementById("lockTermSelect");

      programSelect.innerHTML = "";
      lockTermSelect.innerHTML = "";

      if (!pricingModel) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No pricing uploaded – go to Admin XLS Upload";
        programSelect.appendChild(opt);
        return;
      }

      const programs = Object.values(pricingModel.programs);
      programs.sort((a, b) => a.label.localeCompare(b.label));

      programs.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.label;
        programSelect.appendChild(opt);
      });

      if (programs.length) {
        programSelect.value = programs[0].id;
        populateLockTermsForProgram(programs[0].id);
      }
    }

    function populateLockTermsForProgram(programId) {
      const lockTermSelect = document.getElementById("lockTermSelect");
      lockTermSelect.innerHTML = "";

      if (!pricingModel || !pricingModel.programs[programId]) return;
      const prog = pricingModel.programs[programId];

      const uniqueLockDays = [...new Set(prog.baseGrid.map(r => r.lockDays))].sort((a, b) => a - b);
      uniqueLockDays.forEach(days => {
        const opt = document.createElement("option");
        opt.value = String(days);
        opt.textContent = days + " Days";
        lockTermSelect.appendChild(opt);
      });
    }

    function initForm() {
      const programSelect = document.getElementById("programSelect");
      const pricingForm = document.getElementById("pricingForm");
      const zipInput = document.getElementById("zipInput");
      const purchasePriceInput = document.getElementById("purchasePriceInput");
      const loanAmountInput = document.getElementById("loanAmountInput");
      const ltvInput = document.getElementById("ltvInput");

      programSelect.addEventListener("change", e => {
        populateLockTermsForProgram(e.target.value);
      });

      zipInput.addEventListener("blur", () => {
        updateLocationFromZip(zipInput.value.trim());
      });

      // Auto LTV calc
      purchasePriceInput.addEventListener("input", updateLtvOrLoanFromPair);
      loanAmountInput.addEventListener("input", updateLtvOrLoanFromPair);
      ltvInput.addEventListener("input", updateLtvOrLoanFromPair);

      pricingForm.addEventListener("submit", e => {
        e.preventDefault();
        runPricing();
      });
    }

    function updateLocationFromZip(zip) {
      const locEl = document.getElementById("locationDisplay");
      if (!zip || zip.length < 5) {
        locEl.textContent = "Location auto: – (County: –)";
        return;
      }

      // Very simple stub – you can replace with a real ZIP lookup or static map.
      // For now, we only detect NY vs FL vs NJ vs CT, everything else = "Other".
      let state = "Other";
      if (/^10|^11|^12|^13/.test(zip)) state = "NY";
      if (/^32|^33/.test(zip)) state = "FL";
      if (/^07|^08/.test(zip)) state = "NJ";
      if (/^06/.test(zip)) state = "CT";

      locEl.textContent = `Location auto: ${state} (County: –)`;
    }

    function updateLtvOrLoanFromPair() {
      const purchasePrice = parseFloat(document.getElementById("purchasePriceInput").value);
      const loanAmount = parseFloat(document.getElementById("loanAmountInput").value);
      const ltvField = document.getElementById("ltvInput");

      if (purchasePrice > 0 && loanAmount > 0) {
        const ltv = (loanAmount / purchasePrice) * 100;
        if (!isNaN(ltv)) {
          ltvField.value = ltv.toFixed(2);
        }
        return;
      }

      const ltv = parseFloat(ltvField.value);
      if (purchasePrice > 0 && !isNaN(ltv)) {
        const newLoan = (ltv / 100) * purchasePrice;
        document.getElementById("loanAmountInput").value = Math.round(newLoan / 1000) * 1000;
      }
    }

    function runPricing() {
      const resultArea = document.getElementById("pricingResult");

      if (!pricingModel) {
        resultArea.innerHTML =
          `<p class="text-sm text-red-600">
             No pricing model found. Go to
             <a href="xls-upload.html" class="underline text-blue-600">Admin XLS Upload</a>
             and load the daily .xls sheet from this browser.
           </p>`;
        return;
      }

      const programId = document.getElementById("programSelect").value;
      const lockDays = parseInt(document.getElementById("lockTermSelect").value, 10);
      const occupancy = document.getElementById("occupancySelect").value;
      const propertyType = document.getElementById("propertyTypeSelect").value;
      const ficoBucket = document.getElementById("ficoSelect").value;
      const loanPurpose = document.getElementById("loanPurposeSelect").value;
      const zip = document.getElementById("zipInput").value.trim();
      const purchasePrice = parseFloat(document.getElementById("purchasePriceInput").value);
      const loanAmount = parseFloat(document.getElementById("loanAmountInput").value);
      const ltv = parseFloat(document.getElementById("ltvInput").value);

      if (!programId || isNaN(lockDays) || !loanAmount || isNaN(loanAmount) || isNaN(purchasePrice)) {
        resultArea.innerHTML =
          `<p class="text-sm text-red-600">
             Please fill in Program, Lock Term, ZIP, Purchase Price, and Loan Amount (or LTV).
           </p>`;
        return;
      }

      const prog = pricingModel.programs[programId];
      if (!prog) {
        resultArea.innerHTML =
          `<p class="text-sm text-red-600">
             Program not found in pricing model. Re-upload the rate sheet in Admin XLS Upload.
           </p>`;
        return;
      }

      const eligibleRows = prog.baseGrid.filter(r => r.lockDays === lockDays);
      if (!eligibleRows.length) {
        resultArea.innerHTML =
          `<p class="text-sm text-red-600">
             No rows found for this program & lock term. Check if the rate sheet has prices for ${lockDays} days.
           </p>`;
        return;
      }

      // For now, pick the row with the highest basePrice (best lender credit)
      eligibleRows.sort((a, b) => b.basePrice - a.basePrice);
      const bestRow = eligibleRows[0];

      const basePrice = bestRow.basePrice;

      // TODO: Wire real LLPA and payup using second sheet (now = 0)
      const llpaAdjustment = getLlpaAdjustment({
        programId,
        ltv,
        ficoBucket,
        occupancy,
        propertyType,
        loanPurpose,
        zip
      });

      const payupAdjustment_DU = getPayupAdjustment({
        programId,
        lockDays,
        channel: "DU"
      });

      const payupAdjustment_LP = getPayupAdjustment({
        programId,
        lockDays,
        channel: "LP"
      });

      const brokerCompPoints = BROKER_COMP_PERCENT;

      const finalPrice_DU = basePrice - llpaAdjustment + payupAdjustment_DU + brokerCompPoints;
      const finalPrice_LP = basePrice - llpaAdjustment + payupAdjustment_LP + brokerCompPoints;

      const noteRate = bestRow.rate / 100; // convert to decimal
      const monthlyPi_DU = calcMonthlyPi(loanAmount, noteRate, 30 * 12); // assume 30-year term for now
      const monthlyPi_LP = monthlyPi_DU; // same note rate – channel differences only in price

      resultArea.innerHTML = `
        <div class="space-y-3">
          <div>
            <h3 class="text-sm font-semibold text-slate-800 mb-1">Scenario Summary</h3>
            <p class="text-xs text-slate-600">
              Program: <span class="font-semibold">${prog.label}</span>,
              Lock: <span class="font-semibold">${lockDays} days</span>,
              FICO: <span class="font-semibold">${displayFicoLabel(ficoBucket)}</span>,
              LTV: <span class="font-semibold">${ltv.toFixed(2)}%</span>
            </p>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div class="border border-slate-200 rounded-xl p-3">
              <h4 class="text-sm font-semibold text-slate-800 mb-2">DU (Fannie Mae)</h4>
              <p class="text-sm">
                Note Rate: <span class="font-mono font-semibold">${bestRow.rate.toFixed(3)}%</span>
              </p>
              <p class="text-sm">
                Final Price (incl. LLPA, payups, +${BROKER_COMP_PERCENT.toFixed(2)}% broker comp):
                <span class="font-mono font-semibold">${finalPrice_DU.toFixed(3)}</span>
              </p>
              <p class="text-sm mt-1">
                Monthly P&amp;I (30 yr): <span class="font-mono font-semibold">$${monthlyPi_DU.toLocaleString(undefined,{maximumFractionDigits:2})}</span>
              </p>
              <p class="text-[0.68rem] text-slate-500 mt-1">
                Base: ${basePrice.toFixed(3)},
                LLPA: -${llpaAdjustment.toFixed(3)},
                Payup: +${payupAdjustment_DU.toFixed(3)},
                Broker: +${brokerCompPoints.toFixed(3)}.
              </p>
            </div>

            <div class="border border-slate-200 rounded-xl p-3">
              <h4 class="text-sm font-semibold text-slate-800 mb-2">LP (Freddie Mac)</h4>
              <p class="text-sm">
                Note Rate: <span class="font-mono font-semibold">${bestRow.rate.toFixed(3)}%</span>
              </p>
              <p class="text-sm">
                Final Price (incl. LLPA, payups, +${BROKER_COMP_PERCENT.toFixed(2)}% broker comp):
                <span class="font-mono font-semibold">${finalPrice_LP.toFixed(3)}</span>
              </p>
              <p class="text-sm mt-1">
                Monthly P&amp;I (30 yr): <span class="font-mono font-semibold">$${monthlyPi_LP.toLocaleString(undefined,{maximumFractionDigits:2})}</span>
              </p>
              <p class="text-[0.68rem] text-slate-500 mt-1">
                Base: ${basePrice.toFixed(3)},
                LLPA: -${llpaAdjustment.toFixed(3)},
                Payup: +${payupAdjustment_LP.toFixed(3)},
                Broker: +${brokerCompPoints.toFixed(3)}.
              </p>
            </div>
          </div>

          <p class="text-[0.68rem] text-slate-500">
            This front end only shows note rate &amp; P&amp;I. All LLPA, payup details, and broker compensation
            remain internal and are applied based on the uploaded rate sheet.
          </p>
        </div>
      `;
    }

    function calcMonthlyPi(loanAmount, yearlyRateDecimal, termMonths) {
      const r = yearlyRateDecimal / 12;
      if (r === 0) return loanAmount / termMonths;
      const n = termMonths;
      return loanAmount * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
    }

    // Stub LLPA & Payup – Returns 0 for now.
    // Later you can wire these to the second sheet exactly like we did for base prices.
    function getLlpaAdjustment(scenario) {
      // scenario: { programId, ltv, ficoBucket, occupancy, propertyType, loanPurpose, zip }
      return 0;
    }

    function getPayupAdjustment({ programId, lockDays, channel }) {
      // channel = "DU" or "LP"
      return 0;
    }

    function displayFicoLabel(bucket) {
      const map = {
        "780plus": "780+",
        "760_779": "760-779",
        "740_759": "740-759",
        "720_739": "720-739",
        "700_719": "700-719",
        "680_699": "680-699",
        "660_679": "660-679",
        "640_659": "640-659",
        "620_639": "620-639",
        "lt620": "<620"
      };
      return map[bucket] || bucket;
    }
  </script>
</body>
</html>
