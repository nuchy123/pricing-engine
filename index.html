<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pricing Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Basic styling similar to your screenshot -->
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f5fb;
      color: #111827;
    }
    header {
      background: #1f2937;
      color: #fff;
      padding: 16px 24px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.8;
    }
    main {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }
    .cards-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .card {
      flex: 1 1 320px;
      background: #ffffff;
      border-radius: 10px;
      padding: 16px 18px;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
      min-width: 280px;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #1d4ed8;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #374151;
    }
    .field {
      margin-bottom: 10px;
    }
    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }
    .input-prefix {
      display: flex;
      align-items: center;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      overflow: hidden;
    }
    .input-prefix span {
      padding: 7px 10px;
      background: #f3f4f6;
      border-right: 1px solid #e5e7eb;
      font-size: 13px;
      color: #6b7280;
    }
    .input-prefix input {
      border: none;
      flex: 1;
      padding-left: 8px;
    }
    .actions-row {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
    }
    .btn-primary {
      border: none;
      border-radius: 999px;
      background: #2563eb;
      color: #fff;
      padding: 10px 24px;
      font-size: 15px;
      cursor: pointer;
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .results-card {
      margin-top: 20px;
      padding: 16px 18px;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
    }
    .results-title {
      font-size: 16px;
      margin: 0 0 8px;
      color: #111827;
    }
    .results-value {
      font-size: 18px;
      font-weight: 600;
      margin: 4px 0;
    }
    .muted {
      font-size: 12px;
      color: #6b7280;
    }
    .error {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #fee2e2;
      border: 1px solid #f87171;
      font-size: 13px;
      color: #991b1b;
    }
    /* Admin (backend) panel – hidden unless ?admin=1 */
    #adminPanel {
      display: none;
      margin-bottom: 16px;
      padding: 14px 16px;
      border-radius: 10px;
      background: #eef2ff;
      border: 1px dashed #4f46e5;
      font-size: 13px;
    }
    #adminPanel h3 {
      margin-top: 0;
      font-size: 14px;
      color: #111827;
    }
    #adminPanel small {
      color: #4b5563;
    }
    #fileStatus {
      margin-top: 4px;
    }
    @media (max-width: 800px) {
      .cards-row {
        flex-direction: column;
      }
      .actions-row {
        justify-content: center;
      }
    }
  </style>

  <!-- SheetJS to read xls/xlsx client-side (admin only) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>Scenario Pricing</h1>
  <p>Enter borrower & property info to see the best rate and monthly payment (P&I).</p>
</header>

<main>
  <!-- Admin / backend upload – only visible on ?admin=1 -->
  <div id="adminPanel">
    <h3>Admin: Upload Rate Sheet(s)</h3>
    <small>
      This panel is only visible when you open the page with <code>?admin=1</code> in the URL.<br />
      Example: <code>https://nuchy123.github.io/pricing-engine/?admin=1</code>
    </small>
    <div style="margin-top:8px;">
      <input id="rateFiles" type="file" multiple accept=".xls,.xlsx,.csv" />
      <div id="fileStatus" class="muted">No lender data loaded.</div>
    </div>
  </div>

  <!-- Form cards -->
  <div class="cards-row">
    <!-- Loan Info -->
    <div class="card">
      <h2>Loan Info</h2>

      <div class="field">
        <label for="purchasePrice">Purchase Price</label>
        <div class="input-prefix">
          <span>$</span>
          <input id="purchasePrice" type="number" step="0.01" placeholder="1060000.00" />
        </div>
      </div>

      <div class="field">
        <label for="loanAmount">Loan Amount</label>
        <div class="input-prefix">
          <span>$</span>
          <input id="loanAmount" type="number" step="0.01" placeholder="760000.00" />
        </div>
      </div>

      <div class="field">
        <label for="ltv">LTV (%)</label>
        <input id="ltv" type="number" step="0.01" placeholder="Auto" readonly />
        <div class="muted">Calculated automatically from Purchase Price and Loan Amount.</div>
      </div>

      <div class="field">
        <label for="lockDays">Lock Period</label>
        <select id="lockDays">
          <option value="">Select</option>
          <option value="15">15 Days</option>
          <option value="30" selected>30 Days</option>
          <option value="45">45 Days</option>
          <option value="60">60 Days</option>
        </select>
      </div>
    </div>

    <!-- Property Info -->
    <div class="card">
      <h2>Property Info</h2>

      <div class="field">
        <label for="state">State</label>
        <select id="state">
          <option value="">Select</option>
          <option value="NY">New York</option>
          <option value="NJ">New Jersey</option>
          <option value="FL">Florida</option>
          <option value="CT">Connecticut</option>
        </select>
      </div>

      <div class="field">
        <label for="county">County (optional)</label>
        <input id="county" type="text" placeholder="Rockland County (Monsey)" />
      </div>

      <div class="field">
        <label for="occupancy">Occupancy</label>
        <select id="occupancy">
          <option value="">Select</option>
          <option value="Primary">Primary Residence</option>
          <option value="Second Home">Second Home</option>
          <option value="Investment">Investment</option>
        </select>
      </div>

      <div class="field">
        <label for="propertyType">Legal Structure</label>
        <select id="propertyType">
          <option value="">Select</option>
          <option value="SFR">Single Family</option>
          <option value="Condo">Condo</option>
          <option value="2-4 Unit">2–4 Unit</option>
        </select>
      </div>
    </div>

    <!-- Borrower Info -->
    <div class="card">
      <h2>Borrower Info</h2>

      <div class="field">
        <label for="fico">FICO Score</label>
        <input id="fico" type="number" placeholder="750" />
      </div>

      <div class="field">
        <label for="firstTime">First Time Homebuyer?</label>
        <select id="firstTime">
          <option value="No" selected>No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>

      <div class="field">
        <label for="income">Borrower's Annual Income</label>
        <select id="income">
          <option value="">Not used for pricing</option>
          <option>Below $99,760</option>
          <option>Between $99,760 and $149,640</option>
          <option>Above $149,640</option>
        </select>
      </div>

      <div class="field">
        <label for="escrowWaived">Escrow Waived</label>
        <select id="escrowWaived">
          <option value="No" selected>No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Submit -->
  <div class="actions-row">
    <button id="runPricing" class="btn-primary">Submit</button>
  </div>

  <div id="scenarioError"></div>

  <!-- Results -->
  <div id="results" class="results-card" style="display:none;">
    <p class="results-title">Best Scenario</p>
    <p class="results-value" id="resultRate">Rate: —</p>
    <p class="results-value" id="resultPayment">Monthly Payment (P&amp;I): —</p>
    <p class="muted" id="resultDetails"></p>
  </div>
</main>

<script>
  /********************************************************************
   * 1. Admin panel visibility (backend upload but hidden for users)
   *    Only shown when URL includes ?admin=1
   ********************************************************************/
  const isAdmin = window.location.search.includes("admin=1");
  const adminPanel = document.getElementById("adminPanel");
  const rateFilesInput = document.getElementById("rateFiles");
  const fileStatus = document.getElementById("fileStatus");

  if (isAdmin) {
    adminPanel.style.display = "block";
  }

  /********************************************************************
   * 2. Column mapping – UPDATE to match your Excel headers
   ********************************************************************/
  const columnMapping = {
    lenderName: "Lender",        // optional
    productName: "Product",
    rate: "Rate",
    price: "Price",
    minFico: "MinFICO",
    maxFico: "MaxFICO",
    minLTV: "MinLTV",
    maxLTV: "MaxLTV",
    minLoan: "MinLoan",
    maxLoan: "MaxLoan",
    purpose: "Purpose",
    occupancy: "Occupancy",
    propertyType: "PropType",
    term: "Term",          // years
    lockDays: "LockDays",
    state: "State"
  };

  /********************************************************************
   * 3. Data model: lenders[ { name, products: [rows] } ]
   ********************************************************************/
  let lenders = [];

  if (isAdmin && rateFilesInput) {
    rateFilesInput.addEventListener("change", handleFiles);
  }

  function handleFiles(event) {
    const files = Array.from(event.target.files || []);
    lenders = [];
    fileStatus.textContent = "Loading files…";

    if (!files.length) {
      fileStatus.textContent = "No lender data loaded.";
      return;
    }

    let remaining = files.length;

    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[firstSheetName];
          const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

          lenders.push({
            name: file.name.replace(/\.[^.]+$/, ""),
            products: rows
          });
        } catch (err) {
          console.error("Error parsing", file.name, err);
        } finally {
          remaining--;
          if (remaining === 0) {
            fileStatus.textContent = `Loaded ${lenders.length} lender file(s) for this session.`;
          }
        }
      };
      reader.readAsArrayBuffer(file);
    });
  }

  /********************************************************************
   * 4. Helpers
   ********************************************************************/
  function getNumber(row, key) {
    const raw = row[key];
    if (raw === undefined || raw === null || raw === "") return null;
    const v = Number(String(raw).replace(/[^0-9.\-]/g, ""));
    return isNaN(v) ? null : v;
  }

  function normalizeString(value) {
    if (!value && value !== 0) return "";
    return String(value).trim().toLowerCase();
  }

  function calculateMonthlyPayment(loanAmount, annualRate, years) {
    if (!loanAmount || !annualRate || !years) return null;
    const r = annualRate / 100 / 12;
    const n = years * 12;
    const payment = loanAmount * (r / (1 - Math.pow(1 + r, -n)));
    return payment;
  }

  /********************************************************************
   * 5. LTV auto calculation
   ********************************************************************/
  const purchasePriceInput = document.getElementById("purchasePrice");
  const loanAmountInput   = document.getElementById("loanAmount");
  const ltvInput          = document.getElementById("ltv");

  function updateLTV() {
    const price = Number(purchasePriceInput.value);
    const loan  = Number(loanAmountInput.value);
    if (price && loan) {
      const ltv = (loan / price) * 100;
      ltvInput.value = ltv.toFixed(2);
    } else {
      ltvInput.value = "";
    }
  }

  purchasePriceInput.addEventListener("input", updateLTV);
  loanAmountInput.addEventListener("input", updateLTV);

  /********************************************************************
   * 6. Scenario run
   ********************************************************************/
  const runPricingBtn = document.getElementById("runPricing");
  const scenarioError = document.getElementById("scenarioError");
  const resultsCard   = document.getElementById("results");
  const resultRateEl  = document.getElementById("resultRate");
  const resultPayEl   = document.getElementById("resultPayment");
  const resultDetails = document.getElementById("resultDetails");

  runPricingBtn.addEventListener("click", runScenario);

  function runScenario() {
    scenarioError.innerHTML = "";
    resultsCard.style.display = "none";

    const loanAmount   = Number(loanAmountInput.value);
    const purchasePrice= Number(purchasePriceInput.value);
    const fico         = Number(document.getElementById("fico").value);
    const state        = normalizeString(document.getElementById("state").value);
    const occupancy    = normalizeString(document.getElementById("occupancy").value);
    const propertyType = normalizeString(document.getElementById("propertyType").value);
    const lockDays     = Number(document.getElementById("lockDays").value || 0);

    if (!loanAmount || !purchasePrice || !fico) {
      scenarioError.innerHTML = '<div class="error">Please enter at least Purchase Price, Loan Amount and FICO.</div>';
      return;
    }

    const ltv = (loanAmount / purchasePrice) * 100;

    if (!lenders.length) {
      scenarioError.innerHTML = '<div class="error">No rate sheets loaded. (Open this page with <code>?admin=1</code> and upload your rate sheet.)</div>';
      return;
    }

    let matches = [];

    lenders.forEach(lender => {
      lender.products.forEach(row => {
        const map = columnMapping;

        const rate     = getNumber(row, map.rate);
        const price    = getNumber(row, map.price);
        if (rate === null || price === null) return;

        const rowMinFico = getNumber(row, map.minFico);
        const rowMaxFico = getNumber(row, map.maxFico);
        const rowMinLTV  = getNumber(row, map.minLTV);
        const rowMaxLTV  = getNumber(row, map.maxLTV);
        const rowMinLoan = getNumber(row, map.minLoan);
        const rowMaxLoan = getNumber(row, map.maxLoan);
        const rowTerm    = getNumber(row, map.term) || 30; // default 30 yrs
        const rowLock    = getNumber(row, map.lockDays);

        const rowOccupancy    = normalizeString(row[map.occupancy]);
        const rowPropType     = normalizeString(row[map.propertyType]);
        const rowState        = normalizeString(row[map.state]);

        // Numeric filters
        if (rowMinFico !== null && fico < rowMinFico) return;
        if (rowMaxFico !== null && fico > rowMaxFico) return;
        if (rowMinLTV !== null && ltv  < rowMinLTV)  return;
        if (rowMaxLTV !== null && ltv  > rowMaxLTV)  return;
        if (rowMinLoan!== null && loanAmount < rowMinLoan) return;
        if (rowMaxLoan!== null && loanAmount > rowMaxLoan) return;
        if (lockDays && rowLock !== null && rowLock !== lockDays) return;

        // Text filters
        if (occupancy && rowOccupancy && rowOccupancy !== occupancy) return;
        if (propertyType && rowPropType && rowPropType !== propertyType) return;
        if (state && rowState && rowState !== state) return;

        matches.push({
          rate,
          price,
          term: rowTerm
        });
      });
    });

    if (!matches.length) {
      scenarioError.innerHTML = '<div class="error">No matching rows found for this scenario. Check your column mapping and filters.</div>';
      return;
    }

    // Choose best option by highest price (you can change logic later)
    matches.sort((a, b) => b.price - a.price);
    const best = matches[0];

    const payment = calculateMonthlyPayment(loanAmount, best.rate, best.term);

    resultRateEl.textContent    = `Rate: ${best.rate.toFixed(3)}%`;
    resultPayEl.textContent     = payment
      ? `Monthly Payment (P&I): $${payment.toFixed(2)}`
      : `Monthly Payment (P&I): —`;

    resultDetails.textContent   =
      `Based on loan amount $${loanAmount.toLocaleString()} at ${best.rate.toFixed(3)}% for ${best.term} years.`;

    resultsCard.style.display = "block";
  }
</script>
</body>
</html>
